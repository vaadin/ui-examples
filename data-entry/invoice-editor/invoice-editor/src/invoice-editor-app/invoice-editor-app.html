<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/vaadin-ordered-layout/vaadin-vertical-layout.html">
<link rel="import" href="../../bower_components/vaadin-ordered-layout/vaadin-horizontal-layout.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-select/vaadin-select.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-rich-text-editor/vaadin-rich-text-editor.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../bower_components/vaadin-tabs/vaadin-tabs.html">

<link rel="import" href="../../bower_components/vaadin-notification/vaadin-notification.html">

<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-item.html">

<link rel="import" href="../../bower_components/vaadin-board/vaadin-board.html">
<link rel="import" href="../../bower_components/vaadin-board/vaadin-board-row.html">

<link rel="import" href="../../bower_components/vaadin-grid-pro/vaadin-grid-pro-edit-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid-pro/vaadin-grid-pro.html">

<link rel="import" href="../../bower_components/vaadin-lumo-styles/color.html">
<link rel="import" href="../../bower_components/vaadin-lumo-styles/typography.html">
<link rel="import" href="../../bower_components/vaadin-lumo-styles/sizing.html">
<link rel="import" href="../../bower_components/vaadin-lumo-styles/font-icons.html">

<link rel="import" href="invoice-editor-styles.html">

<script src="../data/dummy-data.js"></script>

<dom-module id="invoice-editor-app">
  <template>
    <style include="invoice-editor-app-styles"></style>
    <div id="controls" board-cols="2">
      <div class="controls-line">
        <div class="invoice-details">
          <span>Invoice #3225</span>
          <small>Draft saved 5 minutes ago</small>
        </div>
        <vaadin-button on-click='__discardChanges' theme="error tertiary">Discard changes</vaadin-button>
        <vaadin-button on-click='__saveDraft' theme="tertiary">Save draft</vaadin-button>
        <vaadin-button on-click='__sendInvoice' theme="primary">Send</vaadin-button>
      </div>
      <vaadin-board>
        <vaadin-board-row>
          <div>
            <vaadin-form-layout id="inputs">
              <vaadin-text-field class="large" colspan="2" label="Invoice Name" value="Devoxx 2018"></vaadin-text-field>
              <vaadin-select label="Employee" value="Manolo">
                <template>
                  <vaadin-list-box>
                    <vaadin-item>Jose</vaadin-item>
                    <vaadin-item>Manolo</vaadin-item>
                    <vaadin-item>Pedro</vaadin-item>
                  </vaadin-list-box>
                </template>
              </vaadin-select>
              <vaadin-date-picker label="Date" value="2018-12-12"></vaadin-date-picker>
            </vaadin-form-layout>
          </div>
          <div board-cols="2">
            <vaadin-rich-text-editor theme="compact"></vaadin-rich-text-editor>
          </div>
        </vaadin-board-row>
      </vaadin-board>
      <div class="controls-line">
        <vaadin-button theme="tertiary" id="add-line" on-click="__addLine">
          <span>Add credit card transaction</span>
        </vaadin-button>
      </div>
      <vaadin-grid-pro multi-sort theme="column-borders compact">
        <vaadin-grid-pro-edit-column path="product" header="Product"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column width="300px" path="description" header="Description"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column path="price" header="Price"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column id="currency" path="currency" header="Currency" editor-type="select"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column path="vat" header="VAT"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column path="amount" header="Amount"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column id="category" path="category" header="Category" editor-type="select"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column id="order" path="order" header="Order completed" editor-type="checkbox"></vaadin-grid-pro-edit-column>
        <vaadin-grid-pro-edit-column path="total" header="Total"></vaadin-grid-pro-edit-column>
        <vaadin-grid-column id="delete" width="70px" text-align="center"></vaadin-grid-edit-column>
      </vaadin-grid-pro>
      <div class="controls-line footer">
        <div class="flex-1"></div>
        <div>
          <span>Total in</span>
          <vaadin-select class="currency-selector">
            <template>
              <vaadin-list-box>
                <vaadin-item>USD</vaadin-item>
                <vaadin-item>EUR</vaadin-item>
                <vaadin-item>GBP</vaadin-item>
              </vaadin-list-box>
            </template>
          </vaadin-select>
          <span>812</span>
        </div>
      </div>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class InvoiceEditorApp extends Polymer.Element {
      static get is() { return 'invoice-editor-app'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'invoice-editor-app'
          }
        };
      }

      ready() {
        super.ready();

        const inputs = this.shadowRoot.querySelector('vaadin-form-layout#inputs');
        inputs.responsiveSteps = [
          {minWidth: 0, columns: 1, labelsPosition: 'top'},
          {minWidth: '30em', columns: 2}
        ];

        const grid = this.shadowRoot.querySelector('vaadin-grid-pro');
        grid.items = window.Vaadin.dummyData;

        grid.querySelectorAll('vaadin-grid-pro-edit-column').forEach(column => {
          column.headerRenderer = function(root) {
            root.innerHTML = `<vaadin-grid-sorter path="${column.path}">${column.header}</vaadin-grid-sorter>`;
          };
        });

        grid.querySelector('#currency').renderer = (root, column, rowData) => {
          let signContainer;
          if (!root.firstElementChild) {
            signContainer = document.createElement('div');
          } else {
            signContainer = root.querySelector('div');
          }

          if (rowData.item.currency === 'eur') {
            signContainer.innerText = '€ ' + rowData.item.currency.toUpperCase();
          } else if (rowData.item.currency === 'usd') {
            signContainer.innerText = '$ ' + rowData.item.currency.toUpperCase();
          } else if (rowData.item.currency === 'gbp') {
            signContainer.innerText = '£ ' + rowData.item.currency.toUpperCase();
          } else {
            signContainer.innerText = '';
          }
          root.appendChild(signContainer);
        };

        grid.querySelector('#delete').renderer = (root, column, rowData) => {
          if (root.firstElementChild) {
            return;
          }
          const deleteBtn = document.createElement('vaadin-button');
          deleteBtn.innerText = 'X';
          deleteBtn.setAttribute('theme', 'small icon');
          deleteBtn.addEventListener('click', e => {
            const updatedArray = grid.items.slice(0);
            updatedArray.splice(rowData.index, 1);
            grid.items = updatedArray;
          });
          root.appendChild(deleteBtn);
        }

        grid.querySelector('#currency').editorOptions = ['eur', 'usd', 'gbp'];
        grid.querySelector('#category').editorOptions = ['Team expenses', 'Personal'];

        grid.addEventListener('item-property-changed', (e => {
          let value = e.detail.value;


          const msg = e.detail.path.charAt(0).toUpperCase() + e.detail.path.slice(1) +
                      ' was updated to be: ' + value +
                      ' for product ' + e.detail.item.product;

          this.__appendInfoNotification(msg);

        }).bind(this));

        const rte = this.shadowRoot.querySelector('vaadin-rich-text-editor');
        rte.value = `[
          {"attributes":{"bold":true},"insert":"Team lunch participants:"},
          {"insert":" Manolo, Joonas, and Matti\\nTraveling in Antwerp:\\nMetro from the hotel to the venue"},
          {"attributes":{"list":"bullet"},"insert":"\\n"},
          {"insert":"Taxi from the airport to the hotel"},
          {"attributes":{"list":"bullet"},"insert":"\\n"}
        ]`;
      }

      __discardChanges() {
        this.__appendInfoNotification('Changes were discard!');
      }

      __saveDraft() {
        this.__appendInfoNotification('Changes were saved!');
      }

      __sendInvoice() {
        this.__appendInfoNotification('Invoice was send!');
      }

      __appendInfoNotification(msg) {
        const notify = window.document.createElement('vaadin-notification');
        notify.renderer = function(root) {
          root.textContent = msg;
        };

        window.document.body.appendChild(notify);
        notify.position = 'bottom-start';
        notify.duration = 3000;
        notify.opened = true;
        notify.addEventListener('opened-changed', function() {
          window.document.body.removeChild(notify);
        });
      }

      __addLine() {
        const grid = this.shadowRoot.querySelector('vaadin-grid-pro');

        grid.push('items', {
          "product": "",
          "description": "",
          "price": "",
          "currency": "",
          "vat": "",
          "amount": "",
          "category": "",
          "total": ""
        });
        grid.render();
      }
    }

    window.customElements.define(InvoiceEditorApp.is, InvoiceEditorApp);

    /**
     * @namespace InvoiceEditorApp
     */
    window.InvoiceEditorApp = window.InvoiceEditorApp || {};
  </script>
</dom-module>
